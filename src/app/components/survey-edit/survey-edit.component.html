<div class="container mx-auto p-4">
    <p-card>
        <ng-template pTemplate="header">
            <div class="flex justify-between items-center">
                <h2>Edit Survey</h2>
                <button pButton label="Back" icon="pi pi-arrow-left" (click)="cancel()" class="p-button-sm p-button-secondary"></button>
            </div>
        </ng-template>

        <form [formGroup]="surveyForm" (ngSubmit)="onSubmit()">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <label>Title</label>
                    <input pInputText formControlName="title" class="w-full" />
                </div>
                <div>
                    <label>Description</label>
                    <textarea pInputTextarea formControlName="description" class="w-full" rows="2"></textarea>
                </div>
            </div>

            <!-- Questions -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-2">
                    <h4>Questions</h4>
                    <button pButton icon="pi pi-plus" class="p-button-sm" (click)="addQuestion()" type="button"></button>
                </div>

                <div *ngFor="let q of questions.controls; let i = index" [formGroupName]="i" class="bg-white p-3 mb-4 border rounded">
                    <div class="flex justify-between items-center">
                        <strong>Q{{ i + 1 }}</strong>
                        <button pButton icon="pi pi-trash" class="p-button-sm p-button-danger p-button-text" (click)="removeQuestion(i)" type="button"></button>
                    </div>

                    <input pInputText placeholder="Question text" formControlName="text" class="w-full mt-2 mb-2" />

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                        <p-dropdown [options]="questionTypes" optionLabel="label" optionValue="value"
                                    formControlName="type" placeholder="Type" class="w-full"></p-dropdown>

                        <p-checkbox formControlName="has_marks" label="Has Marks"></p-checkbox>
                        <p-inputNumber formControlName="marks" placeholder="Marks" [disabled]="!q.get('has_marks')?.value"></p-inputNumber>
                    </div>

                    <p-checkbox formControlName="is_required" label="Required" class="mt-2"></p-checkbox>

                    <div *ngIf="q.get('type')?.value === 'choice' || q.get('type')?.value === 'yesno'" class="mt-3">
                        <div class="flex justify-between items-center mb-1">
                            <label>Choices</label>
                            <button pButton icon="pi pi-plus" class="p-button-sm p-button-text" (click)="addChoice(i)" type="button"></button>
                        </div>

                        <div formArrayName="choices">
                            <div *ngFor="let choice of q.get('choices')['controls']; let j = index" [formGroupName]="j"
                                 class="flex items-center gap-2 mt-1">
                                <input pInputText formControlName="text" placeholder="Option" class="flex-1" />
                                <p-checkbox formControlName="is_correct" binary="true"></p-checkbox>
                                <button pButton icon="pi pi-trash" class="p-button-sm p-button-danger p-button-text" (click)="removeChoice(i, j)" type="button"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Targets -->
            <div class="mt-6">
                <div class="flex justify-between items-center mb-2">
                    <h4>Targets</h4>
                    <button pButton icon="pi pi-plus" class="p-button-sm" (click)="addTarget()" type="button"></button>
                </div>

                <div *ngFor="let t of targets.controls; let i = index" [formGroupName]="i" class="p-3 border rounded mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <p-dropdown [options]="[
                { label: 'Role', value: 'role' },
                { label: 'Department', value: 'department' },
                { label: 'User', value: 'user' },
                { label: 'Site', value: 'site' },
                { label: 'All', value: 'all' }
              ]" formControlName="target_type" class="w-1/3" placeholder="Target Type"></p-dropdown>
                        <button pButton icon="pi pi-trash" class="p-button-sm p-button-danger p-button-text" (click)="removeTarget(i)" type="button"></button>
                    </div>

                    <div *ngIf="t.get('target_type')?.value === 'role'">
                        <input pInputText formControlName="role_name" placeholder="Role Name" class="w-full" />
                    </div>
                    <div *ngIf="t.get('target_type')?.value === 'department'">
                        <p-inputNumber formControlName="department" placeholder="Department ID" class="w-full" />
                    </div>
                    <div *ngIf="t.get('target_type')?.value === 'site'">
                        <p-inputNumber formControlName="site_id" placeholder="Site ID" class="w-full" />
                    </div>
                    <div *ngIf="t.get('target_type')?.value === 'user'">
                        <p-inputNumber formControlName="user_id" placeholder="User ID" class="w-full" />
                    </div>
                    <div *ngIf="t.get('target_type')?.value === 'all'" class="text-sm italic text-gray-600">
                        All users will receive this survey.
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-4">
                <button pButton type="button" label="Cancel" class="p-button-secondary mr-2" (click)="cancel()"></button>
                <button pButton type="submit" label="Save Changes" icon="pi pi-check"></button>
            </div>
        </form>
    </p-card>
</div>
